<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="当你在开发一款应用时，通常会面临发布不同的版本需求。举两个常见的场景，场景一：你正在增加新功能，然后你需要发布版本提交给QA，测试通过后再发布线上版本，可能线下版本和测试版本的服务器接口域名不一样又或者有不同的api接口；场景二：你的app需要发布一个免费版本和付费版本，付费版本会有更高的使用权限，针对如上两种情况你就需要发布四个apk，免费QA版，免费线上版，付费QA版，付费线上版，如果在代买里">
<meta property="og:type" content="article">
<meta property="og:title" content="Android开发中Gradle的使用系列四：创建Build Variants">
<meta property="og:url" content="http://yoursite.com/2016/04/16/2016-04-16-Android开发Gradle的使用系列四之创建BuildVariant/index.html">
<meta property="og:site_name" content="Lee Blog">
<meta property="og:description" content="当你在开发一款应用时，通常会面临发布不同的版本需求。举两个常见的场景，场景一：你正在增加新功能，然后你需要发布版本提交给QA，测试通过后再发布线上版本，可能线下版本和测试版本的服务器接口域名不一样又或者有不同的api接口；场景二：你的app需要发布一个免费版本和付费版本，付费版本会有更高的使用权限，针对如上两种情况你就需要发布四个apk，免费QA版，免费线上版，付费QA版，付费线上版，如果在代买里">
<meta property="og:image" content="http://ww4.sinaimg.cn/large/6b051377gw1f2ylgvqp1pj20ry0yodjb.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/mw690/6b051377gw1f2ylxe43qdj20dk0c6gmm.jpg">
<meta property="og:image" content="http://ww4.sinaimg.cn/mw690/6b051377gw1f2ym04dcu1j20uu04it96.jpg">
<meta property="og:image" content="http://ww4.sinaimg.cn/large/6b051377gw1f2ym6exl4xj20im06eq3c.jpg">
<meta property="og:image" content="http://ww4.sinaimg.cn/mw690/6b051377gw1f2ym73936uj20ic066q3e.jpg">
<meta property="og:updated_time" content="2016-09-25T06:32:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android开发中Gradle的使用系列四：创建Build Variants">
<meta name="twitter:description" content="当你在开发一款应用时，通常会面临发布不同的版本需求。举两个常见的场景，场景一：你正在增加新功能，然后你需要发布版本提交给QA，测试通过后再发布线上版本，可能线下版本和测试版本的服务器接口域名不一样又或者有不同的api接口；场景二：你的app需要发布一个免费版本和付费版本，付费版本会有更高的使用权限，针对如上两种情况你就需要发布四个apk，免费QA版，免费线上版，付费QA版，付费线上版，如果在代买里">
<meta name="twitter:image" content="http://ww4.sinaimg.cn/large/6b051377gw1f2ylgvqp1pj20ry0yodjb.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/04/16/2016-04-16-Android开发Gradle的使用系列四之创建BuildVariant/"/>

  <title> Android开发中Gradle的使用系列四：创建Build Variants | Lee Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Lee Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">专注移动开发</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android开发中Gradle的使用系列四：创建Build Variants
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-16T16:24:30+08:00" content="2016-04-16">
              2016-04-16
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/16/2016-04-16-Android开发Gradle的使用系列四之创建BuildVariant/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/16/2016-04-16-Android开发Gradle的使用系列四之创建BuildVariant/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>当你在开发一款应用时，通常会面临发布不同的版本需求。举两个常见的场景，场景一：你正在增加新功能，然后你需要发布版本提交给QA，测试通过后再发布线上版本，可能线下版本和测试版本的服务器接口域名不一样又或者有不同的api接口；场景二：你的app需要发布一个免费版本和付费版本，付费版本会有更高的使用权限，针对如上两种情况你就需要发布四个apk，免费QA版，免费线上版，付费QA版，付费线上版，如果在代买里面硬编码会使得项目异常复杂。gradle针对这种情况，提出了解决这种问题的方法，对于QA版或线上版可以配置<strong>build type</strong>，Androidstudio默认配置了Debug和Release两种type，对于付费版或者免费版，可以通过配置<strong>Build flavors</strong>。这两种类型组合起来就叫做<strong>build variant</strong></p>
<a id="more"></a>
<h2 id="Build-types"><a href="#Build-types" class="headerlink" title="Build types"></a>Build types</h2><p>Gradle在Android中的build type是用来处理app或者library应该被构建成什么类型，在这个配置中，你可以定义应用的包名是什么，是否自动去除掉没有引用的资源，是否开启混淆等等。具体配置可参考如下代码</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="section">android</span> &#123;</div><div class="line">       <span class="section">buildTypes</span> &#123;</div><div class="line">           <span class="section">release</span> &#123;</div><div class="line">               <span class="attribute">minifyEnabled</span> <span class="literal">false</span></div><div class="line">               proguardFiles getDefaultProguardFile</div><div class="line">                 (<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></div><div class="line">           &#125;</div><div class="line">		&#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你新建一个项目或者模块时，build.gradle文件会默认配置上release的build type，默认配置屏蔽了混淆功能（即将 minifyEnabled设置为false）和定义混淆文件的位置。<br>除了release build type再就是debug build type也是默认创建好的，但是没有在代码里显示出来，如果你想修改默认Debug中的配置，你需要自己声明出来</p>
<blockquote>
<p>debug的build type默认设置debug属性为true，方便调试</p>
</blockquote>
<h3 id="创建build-types"><a href="#创建build-types" class="headerlink" title="创建build types"></a>创建build types</h3><p>当你觉得默认的两种类型不够用是，你也能很容易的自定义build type，如下代码展示了创建一个新的build type名叫<strong>qa_test</strong>的类型</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="section">android</span> &#123;</div><div class="line">    <span class="section">buildTypes</span> &#123;</div><div class="line">		<span class="section">qa_test</span> &#123;</div><div class="line">   			<span class="attribute">applicationIdSuffix</span> <span class="string">".qatest"</span></div><div class="line">    		versionNameSuffix <span class="string">"-qatest"</span></div><div class="line">    		buildConfigField <span class="string">"String"</span>, <span class="string">"API_URL"</span>,<span class="string">"\"http://staging.example.com/api\""</span></div><div class="line">    		&#125; </div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码主要配置qa_test的类型功能为：给包名加上了.qatest的后缀，这样你能在手机上安装相同的程序，应为包名不一样；在version name上加上了-qatest的后缀，然后再BuildConfig类中加了一个API_URL的string属性。</p>
<p>在自定义build type是，你还可以重用已用的build type，如下代码所示</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">android </span>&#123;</div><div class="line">       <span class="keyword">buildTypes </span>&#123;</div><div class="line">           qa_test.initWith(<span class="keyword">buildTypes.debug)</span></div><div class="line">           qa_test &#123;</div><div class="line">               applicationIdSuffix <span class="string">".staging"</span></div><div class="line">               versionNameSuffix <span class="string">"-staging"</span></div><div class="line">               debuggable = false</div><div class="line">&#125; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>initWith()</strong>方法为qa_test类型拷贝了debug类型的所有属性，但是你也可以修改其中的属性，通过显示的声明出来</p>
<h3 id="不同build-types的代码目录结构设置"><a href="#不同build-types的代码目录结构设置" class="headerlink" title="不同build types的代码目录结构设置"></a>不同build types的代码目录结构设置</h3><p>当你创建一个新的builld type，gradle也会默认为你指定一个同名的目录在你的项目里面，但是不会把目录自动创建出来，所以你需要创建一个同名的目录，其结构如下所示</p>
<p><img src="http://ww4.sinaimg.cn/large/6b051377gw1f2ylgvqp1pj20ry0yodjb.jpg" alt=""></p>
<p>这种配置可以使得你在任意build类型去自定义修改，比方说在release的类型登录界面带上正式版本的标示，在debug版本的登录界面就带上登录的标示</p>
<blockquote>
<p><strong>Tips</strong>：当你创建了不同的build type，你在不同的type里面作了不同的修改，但是使用的源是基于main目录下的代码，比方说你要在不同的type里面有不同的login界面，那么main包下面就不能包括LoginActivity，而只在不同buildtype下加入各自自定义的LoginActivity，如果你也在main目录下加入，编译器会提示你dumpllicated file的错误</p>
</blockquote>
<p>对于Resources资源，和处理Java代码有些许不同，对于layout、Drwable资源和图片，如果在不同的type里面定义了，那个定义的这些文件会直接替换掉main目录里面相同的文件；对于String，Color的资源则会合并，举个例子，如果你在main下的string.xml如下</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> &lt;resources&gt;</div><div class="line">       &lt;<span class="built_in">string</span> <span class="built_in">name</span>=<span class="string">"app_name"</span>&gt;TypesAndFlavors&lt;/<span class="built_in">string</span>&gt;</div><div class="line">       &lt;<span class="built_in">string</span> <span class="built_in">name</span>=<span class="string">"hello_world"</span>&gt;Hello world!&lt;/<span class="built_in">string</span>&gt;</div><div class="line">&lt;/resources&gt;</div></pre></td></tr></table></figure>
<p>如果你的qa_test type中的string.xml如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"app_name"</span>&gt;</span>TypesAndFlavors QA_Test<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure>
<p>合并后的string.xml如下所示</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> &lt;resources&gt;</div><div class="line">       &lt;<span class="built_in">string</span> <span class="built_in">name</span>=<span class="string">"app_name"</span>&gt;TypesAndFlavors QA_Test&lt;/<span class="built_in">string</span>&gt;</div><div class="line">       &lt;<span class="built_in">string</span> <span class="built_in">name</span>=<span class="string">"hello_world"</span>&gt;Hello world!&lt;/<span class="built_in">string</span>&gt;</div><div class="line">&lt;/resources&gt;</div></pre></td></tr></table></figure>
<p>如果你没有自定义string那gradle就会默认使用main目录下的string，对于AndroidManifest.xml文件也是一样的，你如果要修改manifest文件不全部拷贝，你只需要加入你需要的代码,gradle会自动合并，在后续部分会更深入的介绍gradle合并的原理</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>每一个build type有可能有自己独立的依赖，如果你配置了，gradle会自动识别配置，例如你要在在debug type中加入一个日志框架，你可以参考如下代码</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">dependencies</span> &#123;</div><div class="line">       <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">       <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:22.2.0'</span></div><div class="line">       debugCompile <span class="string">'de.mindpipe.android:android-logging-log4j:1.0.3'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>debugCompile</strong>表示只在debug type中把log4j加入到编译路径中，关于常用的集中依赖scope请参考<a href="http://yamlee.me/2016/04/13/Android%E5%BC%80%E5%8F%91Gradle%E7%9A%84%E4%BD%BF%E7%94%A8%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8BGradle%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86/" target="_blank" rel="external">系列三:Gradle依赖管理</a></p>
<h2 id="Product-fllavors"><a href="#Product-fllavors" class="headerlink" title="Product fllavors"></a>Product fllavors</h2><blockquote>
<p>与build type相反，build type用来构建不同类型的app，debug版或release版，而produc flavors则是用来在同一个app上创建不同的版本，如付费版和免费版。一个非常常见的应用场景就是你创建了一个银行管理的app给不同银行提供服务，但是不同的银行App的logo不一样，有produc flavors就能在基于一套代码上创建不同版本的app或者library。</p>
<p>如果你不确定什么时候用build type，什么时候改用produc flavors，那么问自己几个问题，如果是构建不同类型供内部使用或者是在google palay上提交一个新的app，那么建议使用build type；如果app要分发在不同的渠道上，那么建议product flavors</p>
</blockquote>
<h3 id="创建-product-flavors"><a href="#创建-product-flavors" class="headerlink" title="创建 product flavors"></a>创建 product flavors</h3><p>创建product flavors与build types非常相似，你只需要添加<strong>productFlavor</strong>代码块，如下代码所示</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> <span class="section">android</span> &#123;</div><div class="line">       <span class="section">productFlavors</span> &#123;</div><div class="line">           <span class="section">red</span> &#123;</div><div class="line">               <span class="attribute">applicationId</span> <span class="string">'com.gradleforandroid.red'</span></div><div class="line">               versionCode <span class="number">3</span></div><div class="line">￼				&#125;</div><div class="line">			blue &#123;</div><div class="line">            	<span class="attribute">applicationId</span> <span class="string">'com.gradleforandroid.blue'</span></div><div class="line">            	minSdkVersion <span class="number">14</span></div><div class="line">            	versionCode <span class="number">4</span></div><div class="line">				&#125; </div><div class="line">		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Product flavors与build types属性不同，因为product flavors其实是ProductFlavors类，build.gradle文件中默认添加的<strong><em>defaultConfig</em></strong>也是ProductFlavors类的实例。</p>
<h3 id="不同product-flavors的代码目录结构设置"><a href="#不同product-flavors的代码目录结构设置" class="headerlink" title="不同product flavors的代码目录结构设置"></a>不同product flavors的代码目录结构设置</h3><p>与build type的设置类似，product flavors也可以配置自己的代码目录</p>
<h3 id="Multiflavor-variants"><a href="#Multiflavor-variants" class="headerlink" title="Multiflavor variants"></a>Multiflavor variants</h3><p>在某些情况下，你可能需要进行flavors的组合，比方说你的app有两套主题，绿色主题和红色主题，然后有两个版本，付费版和免费版，你可能需要进行组合，类似于红色免费，红色收费，绿色免费，绿色收费。通过使用<strong>flavorDimensions</strong>可以解决flavors组合的问题，配置可参考如下代码</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="section">android</span> &#123;</div><div class="line">       <span class="attribute">flavorDimensions</span> <span class="string">"color"</span>, <span class="string">"price"</span></div><div class="line">       productFlavors &#123;</div><div class="line">           <span class="section">red</span> &#123;</div><div class="line">               <span class="attribute">flavorDimension</span> <span class="string">"color"</span></div><div class="line">           &#125;</div><div class="line">           blue &#123;</div><div class="line">               <span class="attribute">flavorDimension</span> <span class="string">"color"</span></div><div class="line">			&#125;</div><div class="line">			free &#123;</div><div class="line">               <span class="attribute">flavorDimension</span> <span class="string">"price"</span></div><div class="line">           &#125;</div><div class="line">            paid &#123;</div><div class="line">               <span class="attribute">flavorDimension</span> <span class="string">"price"</span></div><div class="line">			&#125; </div><div class="line">		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你添加了flavor dimension之后，gradle会判断你是否为flavor指定了flavorDimensions中设定的值，如果没有设置，gradle编译的时候就会报错,而且flavorDimensions中设置的顺序也是非常重要的，比方说如果红色主题的flavor和付费版的flavor中某处代码修改是一样的，那么在运行的时候就以flavorDimensions中配置的先后顺序为准，根据上面的配置，就是以红色主题中的代码为准。</p>
<p>假设你的build type的类型是配置的debug和release那么根据上面代码的配置生成的build variants为如下</p>
<ul>
<li><strong>blueFreeDebug</strong> 和 <strong>blueFreeRelease</strong></li>
<li><strong>bluePaidDebug</strong> 和 <strong>bluePaidRelease</strong></li>
<li><strong>redFreeDebug</strong> 和 <strong>redFreeRelease</strong></li>
<li><strong>redPaidDebug</strong> 和 <strong>redPaidRelease</strong></li>
</ul>
<h2 id="Build-variants"><a href="#Build-variants" class="headerlink" title="Build variants"></a>Build variants</h2><p>build variants就是build type和product flavors组合的结果，当你创建一个新的build type或者product flavor的时候，新的variants也就相应的创建了。例如，如果你的build type是标准的debug和release，那么你创建一个product flavor为red theme和blue theme的时候，相对应的build variants为自动生成，类似于下图</p>
<p><img src="http://ww1.sinaimg.cn/mw690/6b051377gw1f2ylxe43qdj20dk0c6gmm.jpg" alt=""></p>
<p>如上截图为Android Studio中Build Varants的工具框，默认在Android Studio界面的左下角边缘倒数第二个，亦或可以通过View | Tool Windows | Build Variants打开。</p>
<p>如果你没有配置product flavors，variats只会包括build types.如过你也没有配置过build type，Gradle的Android插件也会默认配置debug build type，所以build variants不会出现为空的情况</p>
<h2 id="Tasks"><a href="#Tasks" class="headerlink" title="Tasks"></a>Tasks</h2><p>Gradle的Android插件会根据你配置的build variant自动生成task。一个新的Android app会默认有debug和release两种build type，所以你可以运行<strong>assembleDebug</strong>和<strong>assembleRelease</strong>去生成不同apk，又或者直接运行<strong>assemble</strong>来生成。当你新添加build type，就会相应的添加新的task。当你添加新的flavors product。task重新生成变化较大，因为每一个product flavor和build type是组合的。所以即便是最简单的一个build type和一个flavor的组合，你都会生成有三个对应的task：</p>
<ul>
<li><p><strong>assembleBlue</strong> 使用Blue flavor，相当于运行<strong>assembleBlueRelease</strong>和<strong>assembleBlueDebug</strong></p>
</li>
<li><p><strong>assembleDebug</strong> </p>
</li>
</ul>
<h2 id="代码目录配置（Source-sets）"><a href="#代码目录配置（Source-sets）" class="headerlink" title="代码目录配置（Source sets）"></a>代码目录配置（Source sets）</h2><p>Build variants就是build type和product flavor的组合，比如你源代码中有main，releas，debug，red四个目录，其中，release和debug是build type的类别，red是设置的productflavor，那个对应的build variant就是redReleas,redDebug,也就是说redReleas使用的源码是red和release目录的合并，同理redDebug</p>
<h2 id="资源文件和manifest文件的合并"><a href="#资源文件和manifest文件的合并" class="headerlink" title="资源文件和manifest文件的合并"></a>资源文件和manifest文件的合并</h2><p>正如上面部分所示，不同的build type和product flavor有不同的源码目录，在生成不同的build variant包时，会需要合并资源，例如比方说你在debug build type中的manifest文件设置了要存储log日志的权限，但是在main目录中的manifest文件却不需要，这样在生成编译debug build variant的时候就需要合并main目录中的manifest文件和debug目录中的manifest文件。其中选取的资源的有限及如下图所示：</p>
<p><img src="http://ww4.sinaimg.cn/mw690/6b051377gw1f2ym04dcu1j20uu04it96.jpg" alt=""></p>
<p>如上可知，如果flavor中有一个图片资源为logo.png，main目录中也有一个图片资源为logo.png。在打包的时候，因为flavor的优先级大于Main所以，会使用flavor中的logo.png</p>
<blockquote>
<p>关于资源和manifest文件的合并，有很多具体的细节在这里没法阐述，官方文档给了更多更详细的解释，你可以访问这个地址 <a href="http://tools.android.com/tech-docs/new-build- system/user-guide/manifest-merger" target="_blank" rel="external">Android Developer:Manifest-Merger</a></p>
</blockquote>
<h2 id="创建build-variants"><a href="#创建build-variants" class="headerlink" title="创建build variants"></a>创建build variants</h2><p>gradle使得处理复杂的build varinats非常容易，及时你创建了两种build type和两种product flavors。build文件中代码还是非常清晰明了</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="section">android</span> &#123;</div><div class="line">       <span class="section">buildTypes</span> &#123;</div><div class="line">           <span class="section">debug</span> &#123;</div><div class="line">               <span class="attribute">buildConfigField</span> <span class="string">"String"</span>, <span class="string">"API_URL"</span>,</div><div class="line">               <span class="string">"\"http://test.example.com/api\""</span></div><div class="line">			&#125;</div><div class="line">           staging.initWith(android.buildTypes.<span class="literal">debug</span>)</div><div class="line">           staging &#123;</div><div class="line">               <span class="attribute">buildConfigField</span> <span class="string">"String"</span>, <span class="string">"API_URL"</span>,</div><div class="line">                 <span class="string">"\"http://staging.example.com/api\""</span></div><div class="line">               applicationIdSuffix <span class="string">".staging"</span></div><div class="line">           &#125;</div><div class="line">		&#125;</div><div class="line">       productFlavors &#123;</div><div class="line">           <span class="section">red</span> &#123;</div><div class="line">               <span class="attribute">applicationId</span> <span class="string">"com.gradleforandroid.red"</span></div><div class="line">               resValue <span class="string">"color"</span>, <span class="string">"flavor_color"</span>, <span class="string">"#ff0000"</span></div><div class="line">           &#125;</div><div class="line">           blue &#123;</div><div class="line">               <span class="attribute">applicationId</span> <span class="string">"com.gradleforandroid.blue"</span></div><div class="line">               resValue <span class="string">"color"</span>, <span class="string">"flavor_color"</span>, <span class="string">"#0000ff"</span></div><div class="line">￼￼￼￼￼			&#125; </div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面的代码中，我们创建了四种build variats：blueDebug,blueStaging,redDebug,redStaging.每一个variant都自定义了API URL 和flavor corlor.运行程序bllueDebug可能为如下所示</p>
<p><img src="http://ww4.sinaimg.cn/large/6b051377gw1f2ym6exl4xj20im06eq3c.jpg" alt=""></p>
<p>而redStaging可能如下图所示</p>
<p><img src="http://ww4.sinaimg.cn/mw690/6b051377gw1f2ym73936uj20ic066q3e.jpg" alt=""></p>
<p>第一个截图是blueDebug，使用的是debug build type中的URL和blue product flavor中的颜色，同理可类推redStaging</p>
<h2 id="Variant-filters"><a href="#Variant-filters" class="headerlink" title="Variant filters"></a>Variant filters</h2><p>在某些情况下，可能你不想使用某种build variant，例如你有debug和release的build type，red和bule的flavors但是，blue还是测试环境根本现在用不到bule的release版本，那么你可以直接过滤掉，那么在android stuido中的buildVariants窗口就不会出现了，过滤可以在app模块或者library模块的build.gradle文件中加入如下代码：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">android</span>.variantFilter &#123; variant -&gt;</span></div><div class="line">    <span class="keyword">if</span> (variant.buildType.<span class="keyword">name</span>.equals(<span class="string">'release'</span>)) &#123;</div><div class="line">        <span class="function"><span class="title">variant</span>.getFlavors().each() &#123; flavor -&gt;</span></div><div class="line">            <span class="keyword">if</span> (flavor.<span class="keyword">name</span>.equals(<span class="string">'blue'</span>)) &#123;</div><div class="line">                variant.setIgnore(<span class="literal">true</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>加入以上代码后，再同步项目，在AndroidStudio的BuildVariants窗口就可以看见没有了bule release的版本了</p>
<h2 id="Signing-configuarations-apk包签名配置"><a href="#Signing-configuarations-apk包签名配置" class="headerlink" title="Signing configuarations(apk包签名配置)"></a>Signing configuarations(apk包签名配置)</h2><p>在将app发布到Google Play或者其他应用市场之前，你需要对apk进行秘钥签名。如果你针对用户有免费和付费两个版本，那么你需要给每一个flavor不同的签名，签名的配置代码参考如下</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> <span class="class">android </span>&#123;</div><div class="line">       <span class="class">signingConfigs </span>&#123;</div><div class="line">           staging.initWith(signingConfigs.debug)</div><div class="line">           <span class="class">release </span>&#123;</div><div class="line">               storeFile file(<span class="string">"release.keystore"</span>)</div><div class="line">               storePassword<span class="string">"secretpassword"</span></div><div class="line">               keyAlias <span class="string">"gradleforandroid"</span></div><div class="line">               keyPassword <span class="string">"secretpassword"</span></div><div class="line">&#125; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面的例子里，我们创建了两种不同签名配置</p>
<p>debug类型的签名配置是由gradle的android插件自动生成的，密码的alias name都是默认的。</p>
<blockquote>
<p>Tips：密码建议不要写在build.gradle文件中，可以写在local.properties文件中</p>
</blockquote>
<p>加入了签名配置后，就可以使用签名信息了，代码可参考如下</p>
<p>在buildType中使用</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> <span class="section">android</span> &#123;</div><div class="line">       <span class="section">buildTypes</span> &#123;</div><div class="line">           <span class="section">release</span> &#123;</div><div class="line">               <span class="attribute">signingConfig</span> signingConfigs.release</div><div class="line">￼￼￼￼￼&#125; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在flavors中使用</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> android &#123;</div><div class="line">       buildTypes &#123;</div><div class="line">           release &#123;</div><div class="line">               productFlavors<span class="selector-class">.red</span><span class="selector-class">.signingConfig</span> signingConfigs<span class="selector-class">.red</span></div><div class="line">               productFlavors<span class="selector-class">.blue</span><span class="selector-class">.signingConfig</span> signingConfigs<span class="selector-class">.blue</span></div><div class="line">&#125; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由上代码可知，你不能如下配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> <span class="section">android</span> &#123;</div><div class="line">       <span class="section">productFlavors</span> &#123;</div><div class="line">           <span class="section">blue</span> &#123;</div><div class="line">               <span class="attribute">signingConfig</span> signingConfigs.release</div><div class="line">&#125; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为在合并type和flavor是，flavor会覆盖type中的签名</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在这一部分，主要讨论了build type，produc flavors，和两者的组合以及组合后源码，资源文件的一些细节处理；再就是介绍了签名的配置。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/04/13/2016-04-13-Android开发Gradle的使用系列三之Gradle依赖管理/" rel="next" title="Android开发中Gradle的使用系列三：gradle依赖管理">
                <i class="fa fa-chevron-left"></i> Android开发中Gradle的使用系列三：gradle依赖管理
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/04/16/2016-04-16-Android开发Gradle的使用系列四之创建BuildVariant/"
           data-title="Android开发中Gradle的使用系列四：创建Build Variants" data-url="http://yoursite.com/2016/04/16/2016-04-16-Android开发Gradle的使用系列四之创建BuildVariant/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="YamLee" />
          <p class="site-author-name" itemprop="name">YamLee</p>
          <p class="site-description motion-element" itemprop="description">专注移动开发</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">4</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-types"><span class="nav-number">1.</span> <span class="nav-text">Build types</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建build-types"><span class="nav-number">1.1.</span> <span class="nav-text">创建build types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不同build-types的代码目录结构设置"><span class="nav-number">1.2.</span> <span class="nav-text">不同build types的代码目录结构设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖"><span class="nav-number">1.3.</span> <span class="nav-text">依赖</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Product-fllavors"><span class="nav-number">2.</span> <span class="nav-text">Product fllavors</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-product-flavors"><span class="nav-number">2.1.</span> <span class="nav-text">创建 product flavors</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不同product-flavors的代码目录结构设置"><span class="nav-number">2.2.</span> <span class="nav-text">不同product flavors的代码目录结构设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multiflavor-variants"><span class="nav-number">2.3.</span> <span class="nav-text">Multiflavor variants</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-variants"><span class="nav-number">3.</span> <span class="nav-text">Build variants</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tasks"><span class="nav-number">4.</span> <span class="nav-text">Tasks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码目录配置（Source-sets）"><span class="nav-number">5.</span> <span class="nav-text">代码目录配置（Source sets）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#资源文件和manifest文件的合并"><span class="nav-number">6.</span> <span class="nav-text">资源文件和manifest文件的合并</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建build-variants"><span class="nav-number">7.</span> <span class="nav-text">创建build variants</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Variant-filters"><span class="nav-number">8.</span> <span class="nav-text">Variant filters</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Signing-configuarations-apk包签名配置"><span class="nav-number">9.</span> <span class="nav-text">Signing configuarations(apk包签名配置)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">10.</span> <span class="nav-text">总结</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YamLee</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"yamlee"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
